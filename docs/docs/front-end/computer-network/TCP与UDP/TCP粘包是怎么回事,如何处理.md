---
title: TCP粘包是怎么回事，如何处理?
date: YYYY-MM-DD
---
- 概念
  - TCP粘包就是指发送方发送的若干包数据到达接收方时粘成了一包，从接收缓冲区来看，后一包数据的头紧接着前一包数据的尾，出现粘包的原因是多方面的，可能是来自发送方，也可能是来自接收方。
- 详细
  - 造成TCP粘包的原因
    - （1）发送方原因
      - 默认情况下, TCP 连接会启⽤延迟传送算法 (Nagle 算法), 在数据发送之前缓存他们. 如果短时间有多个数据发送, 会缓冲到⼀起作⼀次发送 (缓冲⼤⼩⻅ socket.bufferSize ), 这样可以减少 IO 消耗提⾼性能.
      - 如果是传输⽂件的话, 那么根本不⽤处理粘包的问题, 来⼀个包拼⼀个包就好了。但是如果是多条消息, 或者是别的⽤途的数据那么就需要处理粘包.
      - TCP默认使用Nagle算法（主要作用：减少网络中报文段的数量），而Nagle算法主要做两件事：
        - 只有上一个分组得到确认，才会发送下一个分组
        - 收集多个小分组，在一个确认到来时一起发送
      - Nagle算法造成了发送方可能会出现粘包问题
    - （2）接收方原因
      - TCP接收到数据包时，并不会马上交到应用层进行处理，或者说应用层并不会立即处理。
      - 实际上，TCP将接收到的数据包保存在接收缓存里，然后应用程序主动从缓存读取收到的分组。
      - 这样一来，如果TCP接收数据包到缓存的速度大于应用程序从缓存中读取数据包的速度，多个包就会被缓存，应用程序就有可能读取到多个首尾相接粘到一起的包。
  - 常⻅的粘包的情况
    - 先接收到 data1 的部分数据, 然后接收到 data1 余下的部分以及 data2 的全部.
    - 先接收到了 data1 的全部数据和 data2 的部分数据, 然后接收到了 data2 的余下的数据.
    - ⼀次性接收到了 data1 和 data2 的全部数据.
  - 常⻅的解决⽅案有:
    - 多次发送之前间隔⼀个等待时间：
      - 需要等上⼀段时间再进⾏下⼀次 send 就好, 
        - 适⽤于交互频率特别低的场景. 
        - 缺点也很明显, 对于⽐较频繁的场景⽽⾔传输效率实在太低，不过⼏乎不⽤做什么处理.
    - 关闭 Nagle 算法：
      - 关闭 Nagle 算法, 
        - 在 Node.js 中你可以通过 socket.setNoDelay() ⽅法来关闭 Nagle 算法, 让每⼀次 send 都不缓冲直接发送。
        - 该⽅法⽐较适⽤于每次发送的数据都⽐较⼤ (但不是⽂件那么⼤), 并且频率不是特别⾼的场景。
        - 如果是每次发送的数据量⽐较⼩, 并且频率特别⾼的, 关闭 Nagle 纯属⾃废武功。
        - 另外, 该⽅法不适⽤于⽹络较差的情况, 因为 Nagle 算法是在服务端进⾏的包合并情况, 但是如果短时间内客户端的⽹络情况不好, 或者应⽤层由于某些原因不能及时将 TCP 的数据 recv, 就会造成多个包在客户端缓冲从⽽粘包的情况。 (如果是在稳定的机房内部通信那么这个概率是⽐较⼩可以选择忽略的)
    - 进⾏封包/拆包：
      - 封包/拆包是⽬前业内常⻅的解决⽅案了。
      - 即给每个数据包在发送之前, 于其前/后放⼀些有特征的数据, 然后收到数据的时 候根据特征数据分割出来各个数据包。
- 注意